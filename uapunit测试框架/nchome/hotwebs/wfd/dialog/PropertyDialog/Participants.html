<!DOCTYPE html> 
	<html> 
	<head> 
	<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
	<title>participants config</title>
	<link rel="stylesheet" type="text/css" href="../../css/easyui/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../css/easyui/icon.css">
	<link rel="stylesheet" type="text/css" href="../../css/refcss/wfex.css">
	<link rel="stylesheet" type="text/css" href="demo.css">
	<script type="text/javascript" src="../../js/libs/easyui/jquery-1.8.0.js"></script>
	<script type="text/javascript" src="../../js/libs/easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript">
		var RESOURCES_PATH = '../../resources';
		var RESOURCE_BASE = RESOURCES_PATH + '/dialog';
		var urlParams = (function(url)
		{	
			var result = new Object();
			var idx = url.lastIndexOf('?');
	
			if (idx > 0)
			{
				var params = url.substring(idx + 1).split('&');
				
				for (var i = 0; i < params.length; i++)
				{
					idx = params[i].indexOf('=');
					
					if (idx > 0)
					{
						result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
					}
				}
			}
			
			return result;
		})(window.location.href);
		// Sets the base path, the UI language via URL param and configures the
		// supported languages to avoid 404s. The loading of all core language
		// resources is disabled as all required resources are in grapheditor.
		// properties. Note that in this example the loading of two resource
		// files (the special bundle and the default bundle) is disabled to
		// save a GET request. This requires that all resources be present in
		// each properties file since only one file is loaded.
		mxLoadResources = true
		mxBasePath = '../../js';
		mxLanguage = urlParams['lang'];
		mxLanguages = ['de','zh-cn'];
	</script>	
	<script type="text/javascript" src="../../js/mxgraph/mxClient.js"></script>
	<script type="text/javascript" src="../../js/mxgraph/util/mxEvent.js"></script>
	<script type="text/javascript" src="../../js/mxgraph/util/mxResources.js"></script>
	<script type="text/javascript" src="../../js/model.js"></script>
	<script type="text/javascript" src="../../js/libs/json/json2.js"></script>
	</head> 
	<body class="easyui-layout" onload= "initialize();"> 

	<div data-options="region:'center'">
	
	<table id="dg" class="easyui-datagrid" title=" " style="width:auto;height:335px;border:4px" border= 0 
	data-options="iconCls: 'icon-edit', singleSelect: true, toolbar: '#tb', onClickRow: onClickRow 	"> 
	</table> 
	 </div>
    <div data-options="region:'east',split:true" style="width:100px;height:50px;" id="buttonsContainer" onresize="resizeButtonsPnl();">
	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add'" id='new' onclick="append()">&nbsp New&nbsp</a> 
	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove'" id='remove' onclick="remove()">Remove</a> 
	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo'" id='up' onclick="onUp()">&nbsp Up &nbsp</a> 
	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search'" id='down' onclick="onDown()">&nbsp Down</a> 
	</div> 
	<div data-options="region:'south',split:true" title="" style="height:60px;padding:0px;background:#efefef">
   <center>
   <a class="easyui-linkbutton" href="javascript:void(0)" id='ok' onclick="onOK()" style="region:'center'">&nbspOK&nbsp&nbsp</a>
   <a class="easyui-linkbutton" href="javascript:void(0)" id='cancel' onclick="onCancel()" style="region:'center'">Cancel</a>
 </center>
 </div> 
	<script type="text/javascript"> 
	 function LocalResources(){}
       mxResources.loadDefaultBundle = false;
 	   mxResources.add(RESOURCE_BASE); 
 	   LocalResources.OK=mxResources.get("ok");      
	   LocalResources.CANCEL=mxResources.get("cancel");
	   LocalResources.TITLE=mxResources.get("participants config");
	   LocalResources.NEW=mxResources.get("new");
	   LocalResources.REMOVE=mxResources.get("remove");
	   LocalResources.UP=mxResources.get("up");
	   LocalResources.DOWN=mxResources.get("down");
	   LocalResources.ParticipanteKind=mxResources.get('ParticipanteKind');
	   LocalResources.ParticipanteName=mxResources.get('ParticipanteName');
	   LocalResources.ParticipanteFilter=mxResources.get('ParticipanteFilter');
	   LocalResources.ParticipanteKey=mxResources.get('ParticipanteKey');
	   LocalResources.ParticipanteCode=mxResources.get('ParticipanteCode');
	   LocalResources.WfUserGroup=mxResources.get('WfUserGroup');
	   LocalResources.RoleGroup=mxResources.get('RoleGroup');
	   LocalResources.UserGroup=mxResources.get('UserGroup');
	   LocalResources.Responsibility=mxResources.get('Responsibility');
	   LocalResources.Post=mxResources.get('Post');
	   LocalResources.Operator=mxResources.get('Operator');
	   LocalResources.Role=mxResources.get('Role');
	   LocalResources.BusiReport=mxResources.get('BusiReport');
	   LocalResources.CustomClass=mxResources.get('CustomClass');
	   LocalResources.SameCorpAndDept=mxResources.get('SameCorpAndDept');
	   LocalResources.SameOrg4Responsibility=mxResources.get('SameOrg4Responsibility');
	   LocalResources.SuperiorOrg4Responsibility=mxResources.get('SuperiorOrg4Responsibility');
	   LocalResources.SameDept=mxResources.get('SameDept');
	   LocalResources.Superior=mxResources.get('Superior');
	   LocalResources.SameCorp=mxResources.get('SameCorp');
	   
	var editIndex = undefined; 
	function endEditing(){ 
		if (editIndex == undefined){return true} 
		if ($('#dg').datagrid('validateRow', editIndex)){ 
			//回写ParticipanteKind
			var ed = $('#dg').datagrid('getEditor', {index:editIndex,field:'ParticipanteKind'}); 
			var ParticipanteKindName = $(ed.target).combobox('getText'); 
			$('#dg').datagrid('getRows')[editIndex]['ParticipanteKindName'] = ParticipanteKindName; 
			//回写ParticipanteFilter	
			var ed1 = $('#dg').datagrid('getEditor', {index:editIndex,field:'ParticipanteFilter'}); 
			var ParticipanteFilterName = $(ed1.target).combobox('getText'); 
			$('#dg').datagrid('getRows')[editIndex]['ParticipanteFilterName'] = ParticipanteFilterName; 		
			$('#dg').datagrid('endEdit', editIndex); 
			editIndex = undefined; 
			return true; 
			} else { 
				return false; 
				} 
	} 
	function onClickRow(index){ 
		if (editIndex != index){ 
			if (endEditing()){	 
			$('#dg').datagrid('selectRow', index) 
			.datagrid('beginEdit', index); 
    		editIndex = index; 
			} else { 
				$('#dg').datagrid('selectRow', editIndex); 
				} 
		} 
	} 
	function append(){
	if (endEditing()){ 
		$('#dg').datagrid('appendRow',{}); 
		editIndex = $('#dg').datagrid('getRows').length-1; 
		$('#dg').datagrid('selectRow', editIndex) 
		.datagrid('beginEdit', editIndex);
	 } 
	} 
	function remove(){ 
		if (editIndex == undefined){return} 
		$('#dg').datagrid('cancelEdit', editIndex) 
		.datagrid('deleteRow', editIndex); 
		editIndex = undefined; 
	} 
	//与上一行交换位置
  function onUp(){
  	 if (editIndex == undefined){return}
	 var editrow = $('#dg').datagrid('getSelected');
	 var currentIndex = $('#dg').datagrid('getRowIndex',editrow);//获得当前行的index
 	 if(currentIndex>0){//当不是第一行的时候
 		 insertRow(currentIndex,-1,editrow);   	
 	  }else{
		$('#dg').datagrid('endEdit', currentIndex);
	  }
	  editIndex = undefined;
	}
	//与下一行进行交换
	function onDown(){
		if (editIndex == undefined){return}
	    var editrow = $('#dg').datagrid('getSelected');
	    var currentIndex = $('#dg').datagrid('getRowIndex',editrow);//获得当前行的index
		//获得当前数据
		var len = $('#dg').last().prevAll().length;
		if(currentIndex<len-1){//当不是最后一行
		    insertRow(currentIndex,1,editrow);		
		}else{
			$('#dg').datagrid('endEdit', currentIndex);
		}
	editIndex = undefined;
	}
	//插入一个新行，moveIndex为需要插入的位置与当前位置的差
	function insertRow(currentIndex,moveIndex,editrow){
		$('#dg').datagrid('endEdit', currentIndex)
  			.datagrid('deleteRow', currentIndex);
			//向后插入一个新行
		$('#dg').datagrid('insertRow',{
 			index:currentIndex+moveIndex,
  			row:editrow
  		}); 
	}
	function onOK(){ 
	if (endEditing()){ 
		$('#dg').datagrid('acceptChanges'); 
		} 
		var returnValue = new Array();
		var participantUser = $('#dg').datagrid('getData');
		var rows= participantUser.rows;
		for(var i=0;i<rows.length;i++){//把行数据转化为对象
		    var participante = new DefaultParticipantDefinition();//对象数组中对象的类型
			participante.code= rows[i].ParticipanteCode;
			participante.name=rows[i].ParticipanteName;
			participante.participantType= rows[i].ParticipanteKind;
			participante.participantFilterType=rows[i].ParticipanteFilter;
			participante.participantID=rows[i].ParticipanteKey;
			returnValue.push(participante);
		}	
		window.returnValue=returnValue;//返回对象数组
    	window.close(); 
	} 
	function onCancel(){
		window.returnValue = undefined;	
		window.close(); 
	}
	function initialize(){
	    document.title = LocalResources.TITLE;
	    document.getElementById('ok').innerHTML = "<SPAN class=l-btn-left><SPAN class=l-btn-text>"+LocalResources.OK+"</SPAN></SPAN>";
	    document.getElementById('cancel').innerHTML = "<SPAN class=l-btn-left><SPAN class=l-btn-text>"+LocalResources.CANCEL+"</SPAN></SPAN>";
	    document.getElementById('new').innerHTML = "<SPAN class=l-btn-left><SPAN class=l-btn-text>"+LocalResources.NEW+"</SPAN></SPAN>";
	    document.getElementById('remove').innerHTML = "<SPAN class=l-btn-left><SPAN class=l-btn-text>"+LocalResources.REMOVE+"</SPAN></SPAN>";
	    document.getElementById('up').innerHTML = "<SPAN class=l-btn-left><SPAN class=l-btn-text>"+LocalResources.UP+"</SPAN></SPAN>";
	    document.getElementById('down').innerHTML = "<SPAN class=l-btn-left><SPAN class=l-btn-text>"+LocalResources.DOWN+"</SPAN></SPAN>";
 		$('#dg').datagrid({
        columns:[[
        	{field:'ParticipanteKind',title:LocalResources.ParticipanteKind,width:100,align:'center', formatter:function(value,row){ return row.ParticipanteKindName;}},
        	{field:'ParticipanteName',title:LocalResources.ParticipanteName,width:120,align:'center'},   
       		{field:'ParticipanteFilter',title:LocalResources.ParticipanteFilter,width:100,align:'center', formatter:function(value,row){ return row.ParticipanteFilterName;}},
        	{field:'ParticipanteKey',title:LocalResources.ParticipanteKey,width:80,align:'center',editor:'text'},
            {field:'ParticipanteCode',title:LocalResources.ParticipanteCode,width:80,align:'center',editor:'text'}
        ]]
        }); 
 	   
 	   var ParticipanteName = $('#dg').datagrid('getColumnOption','ParticipanteName');
	    ParticipanteName.editor={
	       type:'refcolumn',
	       options:{
	       url:'./selectUser.html',
	       features:'dialogHeight:500px;dialogWidth:600px;center:yes',
	       gridid:'dg',
	       keycolumn:'ParticipanteKey',
	       codecolumn:'ParticipanteCode',
	       kind:'kind'
	       }
	     }
	     var dd = null;
	   var ParticipanteKind = $('#dg').datagrid('getColumnOption','ParticipanteKind');
	    ParticipanteKind.editor={
	         type : 'combobox',
	         options : {
	         data:[{value:'WfUserGroup',text:LocalResources.WfUserGroup},{value:'RoleGroup',text:LocalResources.RoleGroup},{value:'UserGroup',text:LocalResources.UserGroup},{value:'Responsibility',text:LocalResources.Responsibility},{value:'Post',text:LocalResources.Post},{value:'Operator',text:LocalResources.Operator},{value:'Role',text:LocalResources.Role},{value:'BusiReport',text:LocalResources.BusiReport},{value:'CustomClass',text:LocalResources.CustomClass}],
	         kind:dd,
	         onChange:function(newValue,oldValue){
	         	if(newValue!=undefined){
	         		ParticipanteName.editor.options.kind = newValue;
	         		}
	         	}
	         }
	       }
	    var ParticipanteFilter = $('#dg').datagrid('getColumnOption','ParticipanteFilter');
	    ParticipanteFilter.editor={
                type:'combobox',
                options:{
                data:[{value:'SameCorpAndDept',text:LocalResources.SameCorpAndDept},{value:'SameOrg4Responsibility',text:LocalResources.SameOrg4Responsibility},{value:'SuperiorOrg4Responsibility',text:LocalResources.SuperiorOrg4Responsibility},{value:'SameDept',text:LocalResources.SameDept},{value:'Superior',text:LocalResources.Superior},{value:'SameCorp',text:LocalResources.SameCorp}]   
                }
               }
		var rows= new Array();
		if (window.dialogArguments){
			var value = window.dialogArguments;//得到的是JSON数据
			var participanteArray= JSON.parse(value);//把json数据转化为对象
			for(var i=0;i<participanteArray.length;i++){
			var row= new Object();
			row.ParticipanteCode= participanteArray[i].code;
			row.ParticipanteName=participanteArray[i].name;
			row.ParticipanteKind= participanteArray[i].participantType;
			row.ParticipanteKindName=mxResources.get(participanteArray[i].participantType);//为了显示的时候为中文
			row.ParticipanteFilter=participanteArray[i].participantFilterType;
			row.ParticipanteFilterName=mxResources.get(participanteArray[i].participantFilterType);
			row.ParticipanteKey=participanteArray[i].participantID;
			rows.push(row);//构造行数据
		}	
		    $('#dg').datagrid('loadData',rows);//载入行数据
		}
		window.onunload=function(){
			if(!window.returnValue)
				window.returnValue = undefined;	
		}
	} 
	</script> 
	</body> 
	</html>
